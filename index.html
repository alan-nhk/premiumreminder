<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¿è²»åˆ°æœŸæé†’ç”¢ç”Ÿå™¨</title>
  <style>
    :root{
      --primary:#0d6efd;
      --border:#e5e7eb;
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748a;
      --radius:10px;
    }
    html,body{height:100%;}
    body{
      margin:0; padding:24px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang HK", "PingFang TC", "Noto Sans TC", "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif;
      color:var(--text); background:var(--bg);
    }
    h1{margin:0 0 20px; font-size:32px; font-weight:800;}
    .container{
      display:grid; gap:24px;
      grid-template-columns: 1.1fr 1fr;
    }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:20px;
      box-shadow:0 1px 2px rgba(0,0,0,0.04);
    }
    label{display:block; font-size:14px; color:var(--muted); margin:10px 0 6px;}
    input, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1px solid var(--border); border-radius:8px; font-size:16px; background:#fff;
    }
    textarea{resize:vertical; min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .btn{
      display:inline-block; width:auto;
      background:var(--primary); color:#fff; border:none; cursor:pointer;
      font-size:18px; padding:12px 20px; border-radius:8px; line-height:1.2;
    }
    .btn:active{opacity:.88}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .muted{color:var(--muted); font-size:13px;}
    .copy-wrap{position:relative;}
    .copy-btn{
      position:absolute; right:10px; top:10px; z-index:1; width:auto;
      padding:8px 12px; font-size:14px; border-radius:6px; background:#111827; color:#fff;
    }
    .msg-box{min-height:260px}
    .checkbox{display:inline-flex; align-items:center; gap:8px; font-size:14px;}
    @media (max-width: 980px){
      .container{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <h1>ä¿è²»åˆ°æœŸæé†’ç”¢ç”Ÿå™¨</h1>

  <div class="container">
    <!-- Left: input + fields -->
    <section class="card">
      <label>è²¼ä¸Šä¿å–®å…¨æ–‡ï¼š</label>
      <textarea id="rawInput" placeholder="åœ¨æ­¤è²¼ä¸Šæ•´ç¯‡ä¿å–®è³‡æ–™â€¦"></textarea>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="btnSend">æå–ä¸¦ç”Ÿæˆ</button>
        <label class="checkbox">
          <input type="checkbox" id="autoSend" checked>
          è‡ªå‹•é€å‡º Webhook
        </label>
      </div>

      <div class="grid-2" style="margin-top:16px;">
        <div>
          <label>Policy Number</label>
          <input id="policyNumber" readonly>
        </div>
        <div>
          <label>Due Date</label>
          <input id="dueDate" placeholder="yyyy-mm-dd" readonly>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Policy Owner Name</label>
          <input id="ownerName" readonly>
        </div>
        <div>
          <label>Insured Name</label>
          <input id="insuredName" readonly>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Premium (é‡‘é¡)</label>
          <input id="premiumRaw" placeholder="ç³»çµ±å°‡ä¾å¹£åˆ¥è¨ˆç®—" readonly>
        </div>
        <div>
          <label>Exchange Rateï¼ˆè‹¥ä¿è²»ç‚ºç¾å…ƒæ™‚ä½¿ç”¨ï¼‰</label>
          <input id="exchangeRate" type="number" step="0.0001" value="7.9">
        </div>
      </div>

      <p class="muted" style="margin-top:12px;">
        å‚™è¨»ï¼šè‹¥ webhook å›ä¾†çš„æ˜¯ <b>US$</b>ï¼Œæœƒä»¥ä¸Šæ–¹åŒ¯ç‡æ›ç®—ï¼›è‹¥æ˜¯ <b>HK$</b> å‰‡ç›´æ¥ä½¿ç”¨ã€‚
      </p>
    </section>

    <!-- Right: messages -->
    <section class="card">
      <h3 style="margin:6px 0 12px">è¨Šæ¯é è¦½ / è¤‡è£½</h3>

      <div class="copy-wrap">
        <button class="copy-btn" data-copy="#whatsappMsg">è¤‡è£½</button>
        <label>WhatsApp è¨Šæ¯</label>
        <textarea id="whatsappMsg" class="msg-box" readonly></textarea>
      </div>

      <div class="copy-wrap" style="margin-top:12px;">
        <button class="copy-btn" data-copy="#wechatMsg">è¤‡è£½</button>
        <label>WeChat è¨Šæ¯</label>
        <textarea id="wechatMsg" class="msg-box" readonly></textarea>
      </div>
    </section>
  </div>

  <script>
    // ====== ä½ çš„ Make Webhook URL ======
    const WEBHOOK_URL = "https://hook.eu2.make.com/6tf86rya7llzle38muijmbwv6ska71g3";

    // é¦–å­—æ¯æ˜ å°„ï¼ˆç¹³è²»è™Ÿç¢¼è¦å‰‡ï¼‰
    const letterMap = { B:'1', E:'2', P:'3', A:'4', C:'5', G:'6', M:'8', V:'9' };

    // è½‰çŸ­åï¼šå»é ­éŠœã€å§“ + åå­—ç¸®å¯«
    function shortName(full){
      if(!full) return "";
      const cleaned = full.replace(/\*/g,'').trim();
      const parts = cleaned.split(/\s+/).filter(p => !/^(MS\.?|MR\.?|MRS\.?)$/i.test(p));
      const surname = parts[0] || "";
      const initials = parts.slice(1).map(p=>p[0]).join(' ');
      return surname + (initials? ' ' + initials : '');
    }

    // yyy-mm-dd => xæœˆxæ—¥ï¼ˆæœ¬åœ°ï¼‰
    function toCNDate(iso){
      if(!iso) return "";
      const d = new Date(iso);
      if(!Number.isFinite(d.getTime())) return iso; // å¾Œå‚™ç›´æ¥é¡¯ç¤º
      return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    }

    // è‹±æ–‡æœˆæ—¥å¹´ => yyy-mm-dd
    function mmmToISO(str){
      const d = new Date(str);
      if(Number.isFinite(d.getTime())){
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${d.getFullYear()}-${m}-${day}`;
      }
      return "";
    }

    // ä¿å–®è™Ÿç¢¼é¦–å­—æ¯è½‰æ•¸å­—
    function toPayNo(policyNo){
      if(!policyNo) return "";
      const f = policyNo[0].toUpperCase();
      if(/[A-Z]/.test(f)){
        return (letterMap[f] || '0') + policyNo.slice(1);
      }
      // ç„¡å­—æ¯ï¼Œå‰ç½®0
      return '0' + policyNo;
    }

    // å¹£åˆ¥è™•ç†ï¼Œå› HKD
    function toHKD(premiumText, rate){
      if(!premiumText) return "0.00";
      const t = premiumText.replace(/,/g,'').trim();
      const hkd = t.match(/HK\$\s*([0-9.]+)/i);
      if(hkd) return Number(hkd[1]).toFixed(2);
      const usd = t.match(/US\$\s*([0-9.]+)/i);
      if(usd) return (Number(usd[1]) * Number(rate || 7.9)).toFixed(2);
      // ç´”æ•¸å­—å¾Œå‚™
      const plain = t.match(/([0-9.]+)/);
      return plain ? Number(plain[1]).toFixed(2) : "0.00";
    }

    // ç”¢ç”Ÿè¨Šæ¯ï¼ˆå›ºå®šç¹³è²»é¡å‹ 01ï¼›Vitality è¦å‰‡ï¼‰
    function buildMessagesFromResult(res){
      // æœŸå¾…çš„éµï¼ˆä¾ä½  Webhook Responseï¼‰
      // ã€ŒæŒæœ‰äººã€ã€Œå—ä¿äººã€ã€Œä¿å–®è™Ÿç¢¼ã€ã€Œé è¨ˆä¿è²»åŠä¿è²»å¾µè²»é‡‘é¡ã€ã€Œä¿è²»åˆ°æœŸæ—¥ã€ã€Œç¹³è²»å½¢å¼ã€
      // ã€ŒAIA Vitality å¥åº·ç¨‹å¼æœƒå“¡è™Ÿç¢¼ã€ã€ŒAIA Vitality å¥åº·ç¨‹å¼æœƒç±ç‹€æ³ã€ã€ŒAIA Vitality å¥åº·ç¨‹å¼æœƒè²»åˆ°æœŸæ—¥ã€
      const ownerFull  = res["æŒæœ‰äºº"] || "";
      const insuredFull= res["å—ä¿äºº"] || "";
      const policyNo   = res["ä¿å–®è™Ÿç¢¼"] || "";
      const premiumRaw = res["é è¨ˆä¿è²»åŠä¿è²»å¾µè²»é‡‘é¡"] || "";
      const dueRaw     = res["ä¿è²»åˆ°æœŸæ—¥"] || "";
      const payMode    = res["ç¹³è²»å½¢å¼"] || "";

      const vitNo   = res["AIA Vitality å¥åº·ç¨‹å¼æœƒå“¡è™Ÿç¢¼"] || "";
      const vitStat = (res["AIA Vitality å¥åº·ç¨‹å¼æœƒç±ç‹€æ³"] || "").trim();
      const vitDue  = res["AIA Vitality å¥åº·ç¨‹å¼æœƒè²»åˆ°æœŸæ—¥"] || "";

      // å¡«å…¥å·¦å´æ¬„ä½
      document.getElementById('policyNumber').value = policyNo;
      document.getElementById('ownerName').value   = ownerFull;
      document.getElementById('insuredName').value = insuredFull;
      document.getElementById('premiumRaw').value  = premiumRaw;

      // æ—¥æœŸæ­£è¦åŒ–
      let dueISO = "";
      if(/\d{4}-\d{2}-\d{2}/.test(dueRaw)) dueISO = dueRaw;
      else if(/[A-Za-z]{3}\s+\d{1,2},\s*\d{4}/.test(dueRaw)) dueISO = mmmToISO(dueRaw);
      document.getElementById('dueDate').value = dueISO;

      // è¨ˆç®—å±•ç¤ºç”¨
      const ownerS = shortName(ownerFull);
      const insuredS = shortName(insuredFull);
      const payNo = toPayNo(policyNo);
      const payType = "01"; // å›ºå®š
      const hkd = toHKD(premiumRaw, document.getElementById('exchangeRate').value);
      const dueCN = toCNDate(dueISO);
      const modeDisplay = /æœˆ/i.test(payMode) ? "æœˆç¹³" : (/å¹´/i.test(payMode) ? "å¹´ç¹³" : payMode || "å¹´ç¹³");

      // Vitality å€å¡Šï¼ˆè‹¥ Terminated -> ä¸é¡¯ç¤ºï¼‰
      let vitalityBlock = "";
      if(vitStat && vitStat.toLowerCase() !== "terminated"){
        let vitDueText = vitDue;
        if(/[A-Za-z]{3}\s+\d{1,2},\s*\d{4}/.test(vitDue)) vitDueText = mmmToISO(vitDue);
        const d = new Date(vitDueText);
        const pretty = Number.isFinite(d.getTime())
          ? `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`
          : vitDue; // å¾Œå‚™ç›´æ¥é¡¯ç¤º
        // æœƒå“¡è™Ÿç¢¼é¦–å­—æ¯ä¹Ÿè½‰ç¢¼
        const vitAcc = vitNo ? toPayNo(vitNo) : "";
        vitalityBlock =
`\nâ—ï¸Vitality ä¿¡æ¯ï¼šâ€¼ï¸
å¸³æˆ¶è™Ÿç¢¼ï¼š${vitAcc}
å¸³æˆ¶ç‹€æ…‹ï¼š${vitStat}
ç¹³è²»é¡å‹ï¼š05
åˆ°æœŸæ—¥ï¼š${pretty}
ç¹³è²»é‡‘é¡ï¼šæ¸¯å¹£430`;
      }

      const wa =
`ğŸŒŸ **æº«é¦¨æç¤º** ğŸŒŸ

ä½ å¥½å‘€ï¼ğŸ˜ŠğŸŒˆ

ä½ çš„ä¿è²»å³å°‡åˆ°æœŸå–‡ï¼š
- *æŒæœ‰äºº*ï¼š${ownerS}
- *ç¹³è²»è™Ÿç¢¼*ï¼š${payNo}
- *ç¹³è²»é¡å‹*ï¼š${payType}
- *å—ä¿äºº*ï¼š${insuredS}
- *ä¿è²»åˆ°æœŸæ—¥*ï¼š${dueCN}
- *ä¿è²»*ï¼šæ¸¯å…ƒ${hkd}
- *ç¹³ä»˜å½¢å¼*ï¼š${modeDisplay}${vitalityBlock}

è¨˜å¾—åœ¨åˆ°æœŸæ—¥å‰ç¹³è²»å•¦ï¼å¦‚æœæœ‰ä»»ä½•å•é¡Œï¼Œéš¨æ™‚å¯ä»¥è¯çµ¡æˆ‘å€‘ã€‚ğŸ“ğŸ’¬

æ„Ÿè¬ä½ çš„æ”¯æŒï¼ğŸŒŸğŸŒº`;

      const wc =
`ğŸŒŸ æº«é¦¨æç¤º ğŸŒŸ

ä½ å¥½å‘€ï¼ğŸ˜ŠğŸŒˆ

ä½ çš„ä¿è²»å³å°‡åˆ°æœŸå–‡ï¼š
- æŒæœ‰äººï¼š${ownerS}
- ç¹³è²»é¡å‹ï¼š${payType}
- ç¹³è²»è™Ÿç¢¼ï¼š${payNo}
- å—ä¿äººï¼š${insuredS}
- ä¿è²»åˆ°æœŸæ—¥ï¼š${dueCN}
- ä¿è²»ï¼šæ¸¯å…ƒ${hkd}
- ç¹³ä»˜å½¢å¼ï¼š${modeDisplay}${vitalityBlock}

è¨˜å¾—åœ¨åˆ°æœŸæ—¥å‰ç¹³è²»å•¦ï¼å¦‚æœæœ‰ä»»ä½•å•é¡Œï¼Œéš¨æ™‚å¯ä»¥è¯çµ¡æˆ‘å€‘ã€‚ğŸ“ğŸ’¬`;

      document.getElementById('whatsappMsg').value = wa;
      document.getElementById('wechatMsg').value  = wc;
    }

    // é€è³‡æ–™åˆ° Webhookï¼ˆäº¤ç”± ChatGPT è§£æï¼‰
    async function sendToWebhook(){
      const raw = document.getElementById('rawInput').value.trim();
      if(!raw){ alert("è«‹å…ˆè²¼ä¸Šä¿å–®å…¨æ–‡"); return; }

      // ä½ åœ¨ Make ç«¯å¯ç›´æ¥æŠŠã€ŒBody.type=jsonã€æ¥ä½
      const payload = JSON.stringify({ text: raw });

      try{
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payload,
          mode: "cors" // ä¼ºæœå™¨éœ€å› Access-Control-Allow-Origin
        });
        if(!res.ok){
          const t = await res.text().catch(()=>res.statusText);
          throw new Error(`HTTP ${res.status}ï¼š${t || "Webhook éŒ¯èª¤"}`);
        }
        const data = await res.json(); // æœŸå¾… webhook response å› JSON
        // è‹¥ Make å›ä¾†æ˜¯å­—ä¸² -> ç›¡é‡è½‰ JSON
        const result = (typeof data === "string") ? JSON.parse(data) : data;

        buildMessagesFromResult(result);
      }catch(err){
        console.error(err);
        alert("Webhook å‘¼å«å¤±æ•—ï¼å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ Make çš„ Webhook Response æ¨¡çµ„ã€‚");
      }
    }

    // äº‹ä»¶ï¼šæŒ‰éˆ•ã€è¤‡è£½ã€è²¼ä¸Šè‡ªå‹•
    document.getElementById('btnSend').addEventListener('click', sendToWebhook);

    document.querySelectorAll('.copy-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sel = btn.getAttribute('data-copy');
        const el = document.querySelector(sel);
        navigator.clipboard.writeText(el.value || "").then(()=> {
          btn.textContent = "å·²è¤‡è£½";
          setTimeout(()=>btn.textContent="è¤‡è£½", 1000);
        });
      });
    });

    // è²¼ä¸Šå³è‡ªå‹•é€å‡ºï¼ˆè‹¥å‹¾é¸ï¼‰
    document.getElementById('rawInput').addEventListener('paste', ()=>{
      setTimeout(()=>{
        if(document.getElementById('autoSend').checked){
          sendToWebhook();
        }
      }, 0);
    });
  </script>
</body>
</html>
