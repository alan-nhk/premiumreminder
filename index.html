<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ä¿è²»åˆ°æœŸæé†’ç”¢ç”Ÿå™¨</title>
  <style>
    :root{
      --bg:#f7f8fa; --card:#fff; --text:#222; --sub:#6b7280; --border:#e5e7eb;
      --primary:#0d6efd; --primary-dark:#0b5ed7; --danger:#dc2626; --ok:#16a34a;
      --radius:12px;
    }
    *{ box-sizing:border-box; }
    html,body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans CJK TC","PingFang TC","Microsoft JhengHei","Helvetica Neue",Arial,sans-serif;
      -webkit-text-size-adjust:100%;
    }
    h1{ margin:24px auto 16px; max-width:1200px; padding:0 16px; font-size:28px; }
    h2{ margin:0 0 12px; font-size:20px; }
    label{ display:block; margin:10px 0 6px; color:var(--sub); font-size:14px; }
    input, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; font-size:16px;
    }
    textarea{ resize:vertical; }
    button{
      display:inline-block; font-size:18px !important; padding:12px 20px !important;
      border:none; border-radius:8px; color:#fff; background:var(--primary); cursor:pointer;
    }
    button:hover{ background:var(--primary-dark); }
    .btn-ghost{ background:#eef2ff; color:#1e3a8a; }
    .container{ max-width:1200px; margin:0 auto; padding:0 16px 24px; }
    .grid{ display:grid; grid-template-columns:minmax(360px,1fr) minmax(360px,1fr); gap:16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted{ color:var(--sub); font-size:13px; }
    .msg{ min-height:260px; white-space:pre-wrap; overflow-wrap:break-word; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .status{ font-size:13px; }
    .status.ok{ color:var(--ok) } .status.err{ color:var(--danger) }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <h1>ä¿è²»åˆ°æœŸæé†’ç”¢ç”Ÿå™¨</h1>
  <div class="container">
    <div class="grid">

      <!-- å·¦æ¬„ï¼šè²¼ä¸Šä¿å–® + è§£ææ¬„ä½ -->
      <section class="card">
        <h2>è²¼ä¸Šä¿å–®å…¨æ–‡</h2>
        <label>åœ¨æ­¤è²¼ä¸Šæ•´ç¯‡ä¿å–®è³‡æ–™ï¼š</label>
        <textarea id="rawInput" class="mono" placeholder="æŠŠä¿å–®åŸæ–‡è²¼åœ¨é€™è£¡â€¦" style="height:160px;"></textarea>

        <div class="row" style="margin:12px 0 4px;">
          <button type="button" onclick="parseRaw()">æå–ä¸¦ç”Ÿæˆ</button>
          <label class="row" style="gap:6px; margin-left:4px;">
            <input type="checkbox" id="autoWebhook" /> è‡ªå‹•é€å‡º Webhook
          </label>
          <button type="button" class="btn-ghost" onclick="sendToWebhook()">æ‰‹å‹•é€å‡º Webhook</button>
          <span id="hookStatus" class="status"></span>
        </div>

        <div class="row" style="gap:16px; margin-top:8px;">
          <div style="flex:1 1 50%;">
            <label>Policy Number</label>
            <input id="policyNumber" type="text" autocomplete="off">
          </div>
          <div style="flex:1 1 50%;">
            <label>Due Date</label>
            <input id="dueDate" type="date" autocomplete="off">
          </div>
        </div>

        <label>Policy Owner Name</label>
        <input id="ownerName" type="text" autocomplete="off">

        <label>Insured Name</label>
        <input id="insuredName" type="text" autocomplete="off">

        <div class="row" style="gap:16px; margin-top:8px;">
          <div style="flex:1 1 50%;">
            <label>Premium (é‡‘é¡)</label>
            <input id="premiumRaw" type="text" placeholder="ç³»çµ±æœƒè‡ªå‹•åµæ¸¬ç¾å…ƒæˆ–æ¸¯å…ƒ" readonly>
          </div>
          <div style="flex:1 1 50%;">
            <label>Exchange Rateï¼ˆè‹¥ä¿è²»ç‚ºç¾å…ƒï¼‰</label>
            <input id="exchangeRate" type="number" step="0.0001" value="7.9">
          </div>
        </div>

        <div style="margin-top:12px;">
          <button type="button" onclick="generateMessages()">ç”Ÿæˆæé†’è¨Šæ¯</button>
          <div class="muted" style="margin-top:6px;">
            ä¿è²»ç¹³è²»é¡å‹å›ºå®š <b>01</b>ï¼›Vitality ç‚º <b>Terminated</b> æ™‚ä¸é¡¯ç¤º Vitality æ®µã€‚ç¾å…ƒæ‰æœƒä¹˜ä»¥åŒ¯ç‡ï¼›æ¸¯å¹£ä¸ä¹˜ã€‚
          </div>
        </div>
      </section>

      <!-- å³æ¬„ï¼šè¨Šæ¯è¼¸å‡º -->
      <section class="card">
        <h2>è¨Šæ¯é è¦½ï¼è¤‡è£½</h2>

        <div style="margin-bottom:12px;">
          <div class="row" style="justify-content:space-between;">
            <div style="font-weight:600;">WhatsApp è¨Šæ¯</div>
            <button onclick="copyToClipboard('whatsappMsg')">è¤‡è£½</button>
          </div>
          <textarea id="whatsappMsg" class="msg" readonly></textarea>
        </div>

        <div>
          <div class="row" style="justify-content:space-between;">
            <div style="font-weight:600;">WeChat è¨Šæ¯</div>
            <button onclick="copyToClipboard('wechatMsg')">è¤‡è£½</button>
          </div>
          <textarea id="wechatMsg" class="msg" readonly></textarea>
        </div>
      </section>

    </div>
  </div>

  <script>
    /* ä½ çš„ Make Webhook */
    const WEBHOOK_URL = "https://hook.eu2.make.com/6tf86rya7llzle38muijmbwv6ska71g3";

    /* å¸¸æ•¸èˆ‡å·¥å…· */
    const letterMap = { B:'1', E:'2', P:'3', A:'4', C:'5', G:'6', M:'8', V:'9' };
    const MAIN_PAY_TYPE = '01'; // å›ºå®š

    function shortName(full=''){
      const safe = String(full).replace(/\*/g,'').trim();
      const parts = safe.split(/\s+/).filter(p => !/^MS\.?$|^MR\.?$|^MRS\.?$/i.test(p));
      const surname = parts[0] || '';
      const initials = parts.slice(1).map(s => s[0]||'').filter(Boolean).join(' ');
      return (surname + (initials? ' '+initials : '')).trim();
    }
    function formatDateCNLocal(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return '';
      return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    }
    function setStatus(msg,isErr){
      const el = document.getElementById('hookStatus');
      el.textContent = msg || '';
      el.className = 'status ' + (isErr ? 'err' : 'ok');
      if(msg) setTimeout(()=>{ el.textContent=''; el.className='status'; }, 5000);
    }

    /* è§£æ */
    let vitalityAccount='', vitalityStatus='', vitalityDueEn='';
    let paymentModeDisplay='', hkPremiumValue='';
    let _overrideOwnerShort=null, _overrideInsuredShort=null, _overrideVitality=null;
    let lastPayload=null;

    function parseRaw(){
      const raw = document.getElementById('rawInput').value || '';
      const lines = raw.split(/\r?\n/);
      let policy='', owner='', insured='', dueIso='', gotUsd=false, gotHkd=false;

      vitalityAccount=''; vitalityStatus=''; vitalityDueEn='';
      hkPremiumValue=''; paymentModeDisplay='';

      for (let line of lines){
        line = line && typeof line==='string' ? line.trim() : '';
        if(!line) continue;

        if(!policy && /^(Policy Details|ä¿å–®è³‡æ–™)/i.test(line)){
          const m = line.match(/-\s*([A-Z0-9]+)/); if(m) policy=m[1];
        }
        if(!owner && /^(Policy Owner|ä¿å–®æŒæœ‰äºº)/i.test(line)){
          owner = line.replace(/^(Policy Owner|ä¿å–®æŒæœ‰äºº)\s*/i,'').replace(/\*.*/,'').trim();
        }
        if(!insured && /^(Insured|å—ä¿äºº)/i.test(line)){
          insured = line.replace(/^(Insured|å—ä¿äºº)\s*/i,'').replace(/\*.*/,'').trim();
        }

        if(!gotUsd){
          const u = line.match(/US\$([0-9,]+\.?[0-9]*)/i);
          if(u){ gotUsd=true; const r=parseFloat(document.getElementById('exchangeRate').value||'7.9');
            hkPremiumValue=(parseFloat(u[1].replace(/,/g,''))*r).toFixed(2);
          }
        }
        if(!gotHkd && !gotUsd){
          const h = line.match(/HK\$([0-9,]+\.?[0-9]*)/i);
          if(h){ gotHkd=true; hkPremiumValue = h[1].replace(/,/g,''); }
        }

        if(!paymentModeDisplay && /^(Payment Mode|ç¹³è²»å½¢å¼)/i.test(line)){
          const val = line.replace(/^(Payment Mode|ç¹³è²»å½¢å¼)\s*/i,'').trim();
          paymentModeDisplay = /MONTHLY|æœˆç¹³/i.test(val)?'æœˆç¹³' : (/ANNUALLY|å¹´ç¹³/i.test(val)?'å¹´ç¹³':val);
        }

        if(!dueIso && /^(Premium Due Date|ä¿è²»åˆ°æœŸæ—¥)/i.test(line)){
          const c = line.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
          if(c){ dueIso=`${c[1]}-${c[2].padStart(2,'0')}-${c[3].padStart(2,'0')}`; }
          else{
            const e = line.match(/([A-Za-z]{3}\s*\d{1,2},\s*\d{4})/);
            if(e){ const d=new Date(e[1]); dueIso=`${d.getFullYear()}-${(d.getMonth()+1+'').padStart(2,'0')}-${(d.getDate()+'').padStart(2,'0')}`; }
          }
        }

        if(/Vitality Membership Number:/i.test(line)){
          const m=line.match(/Vitality Membership Number:\s*([A-Za-z0-9]+)/i);
          if(m){ const f=m[1][0].toUpperCase(); vitalityAccount = (letterMap[f]||'0') + m[1].slice(1); }
        }
        if(/Vitality Membership Status:/i.test(line)){
          const m=line.match(/Vitality Membership Status:\s*([A-Za-z]+)/i);
          if(m){ vitalityStatus=m[1]; }
        }
        if(/Vitality Membership Fee Due Date:/i.test(line)){
          const m=line.match(/Vitality Membership Fee Due Date:\s*([A-Za-z]{3}\s*\d{1,2},\s*\d{4})/i);
          if(m){ vitalityDueEn=m[1]; }
        }
      }

      // å¯«å›æ¬„ä½ï¼ˆé¿å…æŠŠã€Œ=line.replace(...)ã€ç•¶å€¼ï¼‰
      const safe = v => (typeof v==='string' && v.startsWith('=') ? '' : v);
      document.getElementById('policyNumber').value = safe(policy||'');
      document.getElementById('ownerName').value   = safe(owner||'');
      document.getElementById('insuredName').value = safe(insured||'');
      document.getElementById('premiumRaw').value  = hkPremiumValue || '';
      if(dueIso) document.getElementById('dueDate').value = dueIso;

      _overrideOwnerShort = _overrideInsuredShort = null;
      _overrideVitality = null;

      generateMessages();
    }

    function vitalityBlock(){
      const active = _overrideVitality || (
        vitalityAccount && vitalityStatus && vitalityDueEn &&
        String(vitalityStatus).toLowerCase() !== 'terminated'
          ? { account:vitalityAccount, status:vitalityStatus, due:vitalityDueEn, payType:'05', amountHKD:430 }
          : null
      );
      if(!active) return '';
      const d = new Date(active.due || active.dueISO);
      const dueTxt = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
      return `

â—ï¸Vitality ä¿¡æ¯ï¼šâ€¼ï¸
å¸³æˆ¶è™Ÿç¢¼ï¼š${active.account}
å¸³æˆ¶ç‹€æ…‹ï¼š${active.status}
ç¹³è²»é¡å‹ï¼š${active.payType || '05'}
åˆ°æœŸæ—¥ï¼š${dueTxt}
ç¹³è²»é‡‘é¡ï¼šæ¸¯å¹£${active.amountHKD ?? 430}
`;
    }

    function buildPayload(){
      const policy = (document.getElementById('policyNumber').value||'').trim();
      const owner  = (document.getElementById('ownerName').value||'').trim();
      const insured= (document.getElementById('insuredName').value||'').trim();
      const dueISO = (document.getElementById('dueDate').value||'').trim();
      const premHK = (document.getElementById('premiumRaw').value||'0').toString();
      const pm     = paymentModeDisplay || '';

      const payNo = (letterMap[policy[0]?.toUpperCase()]||'0') + policy.slice(1);
      const ownerShort   = _overrideOwnerShort ?? shortName(owner);
      const insuredShort = _overrideInsuredShort ?? shortName(insured);
      const dateCN       = formatDateCNLocal(dueISO);

      const w =
`ğŸŒŸ **æº«é¦¨æç¤º** ğŸŒŸ

ä½ å¥½å‘€ï¼ğŸ˜ŠğŸŒˆ

ä½ çš„ä¿è²»å³å°‡åˆ°æœŸå–‡ï¼š
- *æŒæœ‰äºº*ï¼š${ownerShort}
- *ç¹³è²»è™Ÿç¢¼*ï¼š${payNo}
- *ç¹³è²»é¡å‹*ï¼š${MAIN_PAY_TYPE}
- *å—ä¿äºº*ï¼š${insuredShort}
- *ä¿è²»åˆ°æœŸæ—¥*ï¼š${dateCN}
- *ä¿è²»*ï¼šæ¸¯å…ƒ${premHK}
- *ç¹³ä»˜å½¢å¼*ï¼š${pm}
` + vitalityBlock() + `

è¨˜å¾—åœ¨åˆ°æœŸæ—¥å‰ç¹³è²»å•¦ï¼å¦‚æœæœ‰ä»»ä½•å•é¡Œï¼Œéš¨æ™‚å¯ä»¥è¯çµ¡æˆ‘å€‘ã€‚ğŸ“ğŸ’¬

æ„Ÿè¬ä½ çš„æ”¯æŒï¼ğŸŒŸğŸŒº`;

      const c =
`ğŸŒŸ æº«é¦¨æç¤º ğŸŒŸ

ä½ å¥½å‘€ï¼ğŸ˜ŠğŸŒˆ

ä½ çš„ä¿è²»å³å°‡åˆ°æœŸå–‡ï¼š
- æŒæœ‰äººï¼š${ownerShort}
- ç¹³è²»é¡å‹ï¼š${MAIN_PAY_TYPE}
- ç¹³è²»è™Ÿç¢¼ï¼š${payNo}
- å—ä¿äººï¼š${insuredShort}
- ä¿è²»åˆ°æœŸæ—¥ï¼š${dateCN}
- ä¿è²»ï¼šæ¸¯å…ƒ${premHK}
- ç¹³ä»˜å½¢å¼ï¼š${pm}
` + vitalityBlock() + `

è¨˜å¾—åœ¨åˆ°æœŸæ—¥å‰ç¹³è²»å•¦ï¼å¦‚æœæœ‰ä»»ä½•å•é¡Œï¼Œéš¨æ™‚å¯ä»¥è¯çµ¡æˆ‘å€‘ã€‚ğŸ“ğŸ’¬`;

      let vitality = null;
      if(_overrideVitality){
        const d=new Date(_overrideVitality.due || _overrideVitality.dueISO);
        vitality = {
          account:_overrideVitality.account, status:_overrideVitality.status,
          payType:_overrideVitality.payType || '05',
          dueISO:d.toISOString().slice(0,10), amountHKD:_overrideVitality.amountHKD ?? 430
        };
      }else if(vitalityAccount && vitalityStatus && vitalityDueEn && vitalityStatus.toLowerCase()!=='terminated'){
        const d=new Date(vitalityDueEn);
        vitality = { account:vitalityAccount, status:vitalityStatus, payType:'05', dueISO:d.toISOString().slice(0,10), amountHKD:430 };
      }

      return {
        source:'premium-reminder', version:'2025-11-02',
        policyNumber:policy, payNumber:payNo, payType:MAIN_PAY_TYPE,
        ownerName:owner, insuredName:insured,
        premiumHKD:premHK, premiumCurrency:'HKD',
        dueDateISO:dueISO, dueDateText:dateCN, payModeDisplay:pm,
        vitality, rawInput:document.getElementById('rawInput').value,
        messages:{ whatsapp:w, wechat:c }, createdAt:new Date().toISOString()
      };
    }

    function generateMessages(){
      const p = buildPayload();
      lastPayload = p;
      document.getElementById('whatsappMsg').value = p.messages.whatsapp;
      document.getElementById('wechatMsg').value  = p.messages.wechat;
      if(document.getElementById('autoWebhook').checked) sendToWebhook();
    }

    // â˜… æ”¯æ´ Make çš„ä¸­æ–‡éµåå›å‚³
    function applyWebhookResult(raw) {
      let data = raw;
      if (typeof raw === 'string') { try { data = JSON.parse(raw); } catch { data = null; } }
      if (!data || typeof data !== 'object') return;

      const zhToISO = (s) => {
        if (!s) return '';
        const zh = (s+'').match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
        if (zh) return `${zh[1]}-${zh[2].padStart(2,'0')}-${zh[3].padStart(2,'0')}`;
        const d = new Date(s);
        return isNaN(d) ? '' : `${d.getFullYear()}-${(d.getMonth()+1+'').padStart(2,'0')}-${(d.getDate()+'').padStart(2,'0')}`;
      };
      const pickHKD = (s) => {
        if (!s) return '';
        const m = (s+'').match(/(?:HK\$|æ¸¯å¹£)\s*([\d,]+(?:\.\d+)?)/i);
        if (m) return m[1].replace(/,/g,'');
        const n = (s+'').match(/([\d,]+(?:\.\d+)?)/);
        return n ? n[1].replace(/,/g,'') : '';
      };

      const owner    = data['æŒæœ‰äºº'] || '';
      const insured  = data['å—ä¿äºº'] || '';
      const policyNo = data['ä¿å–®è™Ÿç¢¼'] || '';
      const premHK   = pickHKD(data['é è¨ˆä¿è²»åŠä¿è²»å¾µè²»é‡‘é¡'] || data['é è¨ˆä¿è²»åŠä¿è²»å¾µè²»é‡‘é¡ï¼š']);
      const dueISO   = zhToISO(data['ä¿è²»åˆ°æœŸæ—¥'] || data['ä¿è²»åˆ°æœŸæ—¥ï¼š']);
      const payMode  = data['ç¹³è²»å½¢å¼'] || data['ç¹³è²»å½¢å¼ï¼š'] || '';

      const vitNo    = data['AIA Vitality å¥åº·ç¨‹å¼æœƒå“¡è™Ÿç¢¼'] || data['AIA Vitality å¥åº·ç¨‹å¼æœƒå“¡è™Ÿç¢¼ï¼š'];
      const vitStat  = data['AIA Vitality å¥åº·ç¨‹å¼æœƒç±ç‹€æ³'] || data['AIA Vitality å¥åº·ç¨‹å¼æœƒç±ç‹€æ³ï¼š'];
      const vitDue   = zhToISO(data['AIA Vitality å¥åº·ç¨‹å¼æœƒè²»åˆ°æœŸæ—¥'] || data['AIA Vitality å¥åº·ç¨‹å¼æœƒè²»åˆ°æœŸæ—¥ï¼š']);

      if (policyNo) document.getElementById('policyNumber').value = policyNo;
      if (owner)   document.getElementById('ownerName').value     = owner;
      if (insured) document.getElementById('insuredName').value   = insured;
      if (premHK)  document.getElementById('premiumRaw').value    = premHK;
      if (dueISO)  document.getElementById('dueDate').value       = dueISO;
      if (payMode) paymentModeDisplay = /æœˆ/i.test(payMode) ? 'æœˆç¹³' : (/å¹´|ann/i.test(payMode) ? 'å¹´ç¹³' : payMode);

      _overrideVitality = null;
      if (vitNo && vitStat && vitDue) {
        if ((vitStat+'').toLowerCase() !== 'terminated') {
          const f = vitNo[0]?.toUpperCase?.() || '';
          const mapped = (letterMap[f] || '0') + vitNo.slice(1);
          _overrideVitality = {
            account: mapped, status: vitStat, payType: '05',
            dueISO: vitDue, amountHKD: 430
          };
        }
      }

      generateMessages();
    }

    async function sendToWebhook(){
      try{
        const payload = lastPayload || buildPayload();
        if(!WEBHOOK_URL){ setStatus('æœªè¨­å®š Webhook URL', true); return; }

        setStatus('å‚³é€ä¸­â€¦');
        const res = await fetch(WEBHOOK_URL,{
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify(payload)
        });
        if(!res.ok){ const t=await res.text(); throw new Error(`HTTP ${res.status} ${t||''}`); }

        let data; const ct=res.headers.get('content-type')||'';
        if(ct.includes('application/json')) data=await res.json();
        else{ const txt=await res.text(); try{ data=JSON.parse(txt); }catch{ data=null; } }

        if(data){
          // 1) è‹¥å› messages ç›´æ¥è¦†å¯«
          if(data.messages){
            if(data.messages.whatsapp) document.getElementById('whatsappMsg').value = data.messages.whatsapp;
            if(data.messages.wechat)   document.getElementById('wechatMsg').value   = data.messages.wechat;
          }
          // 2) åŒæ™‚æ”¯æ´ä½ çš„ä¸­æ–‡éµåå›å¡«
          applyWebhookResult(data);
        }
        setStatus('å·²é€å‡º âœ…', false);
      }catch(e){ console.error(e); setStatus('é€å‡ºå¤±æ•—ï¼š'+e.message, true); }
    }

    function copyToClipboard(id){
      const el=document.getElementById(id);
      el.select(); el.setSelectionRange(0,99999);
      navigator.clipboard.writeText(el.value).then(()=>alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼'));
    }
  </script>
</body>
</html>
