<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>保費到期提醒產生器（Webhook 版）</title>
  <style>
    :root{
      --brand:#0d6efd;
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --ok:#16a34a;
      --err:#dc2626;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      color:var(--text); background:var(--bg);
    }
    header{
      padding:20px 24px; background:#fff; position:sticky; top:0; z-index:10;
      border-bottom:1px solid #e5e7eb;
    }
    h1{margin:0; font-size:24px; letter-spacing:.02em}
    .wrap{padding:20px; max-width:1200px; margin:0 auto}
    .grid{
      display:grid; grid-template-columns:1.1fr .9fr; gap:20px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
    }
    .card{
      background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius);
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card header{
      padding:14px 16px; border-bottom:1px solid #eef0f4; position:static;
    }
    .card header h2{margin:0; font-size:18px}
    .card .body{ padding:16px; }
    label{display:block; font-weight:600; margin:10px 0 6px}
    textarea,input[type="text"]{
      width:100%; padding:12px 14px; border:1px solid #d1d5db; border-radius:10px;
      font-family: ui-monospace,SFMono-Regular,Menlo,monospace; font-size:14px;
      background:#fff;
    }
    textarea{ min-height:180px; resize:vertical; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      appearance:none; border:0; border-radius:10px; padding:12px 18px;
      background:var(--brand); color:#fff; font-weight:600; cursor:pointer;
      font-size:16px; min-height:48px;
    }
    .btn.secondary{ background:#111827; }
    .btn.ghost{ background:#eef2ff; color:#3730a3 }
    .btn.small{ font-size:14px; padding:8px 12px; min-height:38px }
    .hint{ color:var(--muted); font-size:13px; margin-top:6px }
    .status{ font-size:13px; margin-left:8px }
    .status.ok{ color:var(--ok) }
    .status.err{ color:var(--err) }
    .outbox{ position:relative }
    .copyBar{
      position:absolute; top:10px; right:10px; display:flex; gap:8px;
    }
    .copyBar .btn{ min-height:36px; padding:8px 12px; font-size:13px; }
    .msg{
      width:100%; min-height:260px; border:1px solid #e5e7eb; border-radius:10px;
      padding:12px 14px; font-family: ui-monospace,SFMono-Regular,Menlo,monospace;
      background:#fafafa; white-space:pre-wrap; line-height:1.55; font-size:14px;
    }
    .split{
      display:grid; grid-template-columns:1fr; gap:12px;
    }
    .switch{
      display:inline-flex; align-items:center; gap:8px; font-size:14px; color:#334155
    }
    .switch input{ width:18px; height:18px }
  </style>
</head>
<body>
  <header><h1>保費到期提醒產生器（Webhook 版）</h1></header>

  <div class="wrap">
    <div class="grid">
      <!-- 左側：輸入與送出 -->
      <section class="card">
        <header><h2>貼上保單全文</h2></header>
        <div class="body">
          <label for="raw">在此貼上整篇保單資料：</label>
          <textarea id="raw" placeholder="把 AIA 的保單頁全文貼在這裡…"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnSend">送到 Webhook 分析</button>
            <button class="btn ghost" id="btnClear">清空</button>
            <label class="switch">
              <input type="checkbox" id="autoCopy" checked />
              取得回應後自動覆蓋到右側訊息框
            </label>
            <span id="netStatus" class="status"></span>
          </div>

          <p class="hint">
            • 這個頁面會把你貼上的內容用 <code>POST JSON</code> 送到你的 Make.com Webhook：<br>
            <code>https://hook.eu2.make.com/6tf86rya7llzle38muijmbwv6ska71g3</code><br>
            • Webhook 的回應會直接顯示在右側 WhatsApp / WeChat 訊息框。
          </p>
        </div>
      </section>

      <!-- 右側：訊息預覽 -->
      <section class="card">
        <header><h2>訊息預覽 / 複製</h2></header>
        <div class="body split">
          <div class="outbox">
            <div class="copyBar">
              <button class="btn small" onclick="copyMsg('wa')">複製</button>
            </div>
            <label for="wa">WhatsApp 訊息</label>
            <pre id="wa" class="msg"></pre>
          </div>

          <div class="outbox">
            <div class="copyBar">
              <button class="btn small" onclick="copyMsg('wc')">複製</button>
            </div>
            <label for="wc">WeChat 訊息</label>
            <pre id="wc" class="msg"></pre>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const WEBHOOK = "https://hook.eu2.make.com/6tf86rya7llzle38muijmbwv6ska71g3";
    const rawEl = document.getElementById('raw');
    const waEl  = document.getElementById('wa');
    const wcEl  = document.getElementById('wc');
    const btnSend = document.getElementById('btnSend');
    const btnClear = document.getElementById('btnClear');
    const netStatus = document.getElementById('netStatus');
    const autoCopy = document.getElementById('autoCopy');

    function setStatus(text, ok=false, err=false){
      netStatus.textContent = text || '';
      netStatus.className = 'status' + (ok?' ok':'') + (err?' err':'');
    }

    function normalizeVitalitySpacing(text){
      if(!text) return text;
      // 在「=VItality健康程式資料=」或「❗️Vitality 信息」前面加一行空白
      return text
        .replace(/(\S)\n(=VItality健康程式資料=)/g, '$1\n\n$2')
        .replace(/(\S)\n(❗️?Vitality[^\n]*)/g, '$1\n\n$2');
    }

    async function sendToWebhook(){
      const payload = {
        raw: rawEl.value || '',
        meta: {
          source: 'premiumreminder-web',
          ua: navigator.userAgent,
          ts: new Date().toISOString()
        }
      };
      if(!payload.raw.trim()){
        setStatus('請先貼上內容', false, true);
        rawEl.focus();
        return;
      }

      btnSend.disabled = true;
      setStatus('傳送中…');

      try{
        const res = await fetch(WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const text = await res.text(); // 可能是純文字或 JSON
        if(!res.ok){
          throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
        }

        let out = text;
        // 如果回應是 JSON，嘗試取常見欄位；否則原樣顯示
        try{
          const j = JSON.parse(text);
          // 常見路徑：Make 的「Webhook response」直接回傳字串本文
          // 也可能包在 {message: "..."} 或 {data: "..."} 等欄位
          out = j.message || j.data || j.text || j.result || JSON.stringify(j, null, 2);
        }catch(_){ /* 不是 JSON，直接使用原始 text */ }

        out = normalizeVitalitySpacing(out);

        if(autoCopy.checked){
          waEl.textContent = out;
          wcEl.textContent = out;
        }
        setStatus('完成 ✔', true, false);
      }catch(err){
        console.error(err);
        setStatus('發送失敗：' + err.message, false, true);
      }finally{
        btnSend.disabled = false;
      }
    }

    function copyMsg(id){
      const el = (id==='wa') ? waEl : wcEl;
      if(!el.textContent.trim()){
        setStatus('沒有可複製的文字', false, true); return;
      }
      navigator.clipboard.writeText(el.textContent)
        .then(()=> setStatus('已複製到剪貼簿 ✔', true, false))
        .catch(e => setStatus('複製失敗：' + e.message, false, true));
    }

    btnSend.addEventListener('click', sendToWebhook);
    btnClear.addEventListener('click', () => {
      rawEl.value = '';
      waEl.textContent = '';
      wcEl.textContent = '';
      setStatus('');
      rawEl.focus();
    });

    // 支援 Cmd/Ctrl + Enter 直接送出
    rawEl.addEventListener('keydown', (e)=>{
      if((e.metaKey || e.ctrlKey) && e.key === 'Enter'){
        e.preventDefault();
        sendToWebhook();
      }
    });
  </script>
</body>
</html>
