<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¿è²»åˆ°æœŸæé†’ç”¢ç”Ÿå™¨</title>
  <style>
    :root{
      --bg:#f7f8fa; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#0d6efd; --primary-dark:#0b5ed7; --success:#16a34a; --danger:#dc2626;
      --radius:12px; --gap:20px;
    }
    *{box-sizing:border-box}
    body{ margin:0; padding:24px; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans CJK TC","Helvetica Neue",Arial,"PingFang TC","Microsoft JhengHei",sans-serif; color:var(--text); background:var(--bg);}
    h1{margin:0 0 20px; font-size:28px}
    h2{margin:0 0 12px; font-size:20px}
    label{display:block; margin:10px 0 6px; font-size:14px; color:var(--muted)}
    input, textarea{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; font-size:16px; }
    textarea{resize:vertical}
    button{ display:inline-block; font-size:16px; padding:10px 16px; border:none; border-radius:8px; color:#fff; background:var(--primary); cursor:pointer; transition:.2s background; }
    button:hover{ background:var(--primary-dark) }
    .btn-ghost{ background:#eef2ff; color:#1e3a8a }
    .btn-danger{ background:var(--danger) }

    .container{ max-width:1200px; margin:0 auto; }
    .layout{ display:grid; grid-template-columns:1.1fr .9fr; gap:var(--gap); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .stack > * + *{ margin-top:12px; }
    .split-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .muted{ color:var(--muted); font-size:13px; }
    .copy-row{ display:flex; gap:10px; align-items:center; }
    .copy-row .fill{ flex:1 1 auto; }
    .msg-box{ min-height:260px; white-space:pre-wrap; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .status{ font-size:13px; }
    .status.ok{ color:var(--success) }
    .status.err{ color:var(--danger) }
    @media (max-width: 960px){ .layout{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ä¿è²»åˆ°æœŸæé†’ç”¢ç”Ÿå™¨</h1>

    <div class="layout">
      <!-- å·¦æ¬„ï¼šè²¼ä¸Šä¿å–® + è§£æå¾Œæ¬„ä½ -->
      <section class="card">
        <h2>è²¼ä¸Šä¿å–®å…¨æ–‡</h2>
        <label>åœ¨æ­¤è²¼ä¸Šæ•´ç¯‡ä¿å–®è³‡æ–™ï¼š</label>
        <textarea id="rawInput" placeholder="æŠŠä¿å–®åŸæ–‡è²¼åœ¨é€™è£¡â€¦" style="height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></textarea>
        <div class="row">
          <button type="button" onclick="parseRaw()">æå–ä¸¦ç”Ÿæˆ</button>
          <label class="row" style="gap:6px; margin:0 0 0 8px;">
            <input type="checkbox" id="autoWebhook" /> è‡ªå‹•é€å‡ºåˆ° Webhook
          </label>
          <button type="button" class="btn-ghost" onclick="sendToWebhook()">æ‰‹å‹•é€å‡º Webhook</button>
          <span id="hookStatus" class="status"></span>
        </div>

        <div class="stack" style="margin-top:18px;">
          <div class="split-2">
            <div>
              <label>Policy Number</label>
              <input type="text" id="policyNumber" />
            </div>
            <div>
              <label>Due Date</label>
              <input type="date" id="dueDate" />
            </div>
          </div>

          <div>
            <label>Policy Owner Name</label>
            <input type="text" id="ownerName" />
          </div>

          <div>
            <label>Insured Name</label>
            <input type="text" id="insuredName" />
          </div>

          <div class="split-2">
            <div>
              <label>Premium (é‡‘é¡)</label>
              <input type="text" id="premiumRaw" placeholder="ç³»çµ±æœƒè‡ªå‹•åµæ¸¬ç¾å…ƒæˆ–æ¸¯å…ƒ" readonly />
            </div>
            <div>
              <label>Exchange Rateï¼ˆè‹¥ä¿è²»ç‚ºç¾å…ƒï¼‰</label>
              <input type="number" step="0.0001" id="exchangeRate" value="7.9" />
            </div>
          </div>

          <div>
            <button type="button" onclick="generateMessages()">ç”Ÿæˆæé†’è¨Šæ¯</button>
            <div class="muted">æç¤ºï¼šä¿è²»ç¹³è²»é¡å‹å›ºå®š <b>01</b>ï¼›Vitality ç‹€æ…‹ç‚º <b>Terminated</b> æ™‚ä¸è¼¸å‡º Vitality è³‡è¨Šã€‚ç¾å…ƒæ‰æœƒä¹˜ä»¥åŒ¯ç‡ï¼›æ¸¯å¹£ä¸ä¹˜ã€‚</div>
          </div>
        </div>
      </section>

      <!-- å³æ¬„ï¼šè¨Šæ¯è¼¸å‡º -->
      <section class="card">
        <h2>è¨Šæ¯é è¦½ / è¤‡è£½</h2>

        <div class="stack">
          <div>
            <div class="copy-row">
              <h3 style="margin:0; font-size:16px;">WhatsApp è¨Šæ¯</h3>
              <span class="fill"></span>
              <button onclick="copyToClipboard('whatsappMsg')">è¤‡è£½</button>
            </div>
            <textarea id="whatsappMsg" class="msg-box" readonly></textarea>
          </div>

          <div>
            <div class="copy-row">
              <h3 style="margin:0; font-size:16px;">WeChat è¨Šæ¯</h3>
              <span class="fill"></span>
              <button onclick="copyToClipboard('wechatMsg')">è¤‡è£½</button>
            </div>
            <textarea id="wechatMsg" class="msg-box" readonly></textarea>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== ä½ çš„ Make Webhook ç«¯é» =====
    const WEBHOOK_URL = "https://hook.eu2.make.com/6tf86rya7llzle38muijmbwv6ska71g3";

    // å›ºå®šè¦å‰‡
    const letterMap = { B:'1', E:'2', P:'3', A:'4', C:'5', G:'6', M:'8', V:'9' };
    const MAIN_PAY_TYPE = '01'; // ä¿è²»ç¹³è²»é¡å‹å›ºå®š 01

    // çŸ­å§“åï¼šå»æ‰ç¨±è¬‚ï¼Œå–å§“ + åé¦–å­—æ¯
    function shortName(full) {
      let parts = (full||'').trim().replace(/\*/g,'').split(/\s+/)
        .filter(p => !/^MS\.?$|^MR\.?$|^MRS\.?$/i.test(p));
      const surname = parts[0]||'';
      const initials = parts.slice(1).map(n=>n.charAt(0)).join(' ');
      return surname + (initials? ' '+initials : '');
    }
    // è½‰ ISO æ—¥æœŸç‚ºã€ŒMæœˆDæ—¥ã€
    function formatDateCNLocal(dateStr) {
      if(!dateStr) return '';
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return '';
      return (d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥';
    }

    // ç‹€æ…‹è®Šé‡
    let vitalityAccount = '', vitalityStatus = '', tmpVitalDue = '';
    let hkPremiumValue = '';
    let lastPayload = null;
    // å…è¨± webhook å›è¦†è¦†å¯«çš„æ¬„ä½
    let _overrideOwnerShort = null, _overrideInsuredShort = null, _overrideVitality = null;

    function parseRaw() {
      const raw = document.getElementById('rawInput').value;
      const lines = raw.split(/\r?\n/);

      let policy='', owner='', insured='', dueIso='', paymentModeDisplay='';
      let rawPremiumValue = '';
      vitalityAccount = ''; vitalityStatus = ''; tmpVitalDue = '';
      hkPremiumValue = '';

      lines.forEach(line=>{
        line=line.trim(); if(!line) return;

        if(!policy && /^(Policy Details|ä¿å–®è³‡æ–™)/i.test(line)) {
          const m=line.match(/-\s*([A-Z0-9]+)/); if(m) policy=m[1].trim();
        }
        if(!owner && /^(Policy Owner|ä¿å–®æŒæœ‰äºº)/i.test(line)) {
          owner=line.replace(/^(Policy Owner|ä¿å–®æŒæœ‰äºº)\s*/i,'').replace(/\*.*/,'').trim();
        }
        if(!insured && /^(Insured|å—ä¿äºº)/i.test(line)) {
          insured=line.replace(/^(Insured|å—ä¿äºº)\s*/i,'').replace(/\*.*/,'').trim();
        }
        if(!rawPremiumValue) { // USD
          const mUsd=line.match(/US\$([0-9,]+\.?[0-9]*)/i);
          if(mUsd) {
            rawPremiumValue = mUsd[1].replace(/,/g,'');
            const rate = parseFloat(document.getElementById('exchangeRate').value||'7.9');
            hkPremiumValue = (parseFloat(rawPremiumValue)*rate).toFixed(2);
          }
        }
        if(!rawPremiumValue) { // HKD
          const mHkd=line.match(/HK\$([0-9,]+\.?[0-9]*)/i);
          if(mHkd) { rawPremiumValue = mHkd[1].replace(/,/g,''); hkPremiumValue = rawPremiumValue; }
        }
        if(!paymentModeDisplay && /^(Payment Mode|ç¹³è²»å½¢å¼)/i.test(line)) {
          const m=line.split(/^(?:Payment Mode|ç¹³è²»å½¢å¼)/i)[1].trim();
          paymentModeDisplay = /MONTHLY|æœˆç¹³/i.test(m)?'æœˆç¹³':(/ANNUALLY|å¹´ç¹³/i.test(m)?'å¹´ç¹³':m);
        }
        if(!dueIso && /^(Premium Due Date|ä¿è²»åˆ°æœŸæ—¥)/i.test(line)) {
          const mCh=line.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
          if(mCh) { dueIso=`${mCh[1]}-${mCh[2].padStart(2,'0')}-${mCh[3].padStart(2,'0')}`; }
          else {
            const mEn=line.match(/([A-Za-z]{3}\s*\d{1,2},\s*\d{4})/i);
            if(mEn) { const d=new Date(mEn[1]); dueIso=`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`; }
          }
        }
        if(/Vitality Membership Number:/i.test(line)) {
          const m=line.match(/Vitality Membership Number:\s*([A-Za-z0-9]+)/i);
          if(m) { const f=m[1].charAt(0).toUpperCase(); vitalityAccount=(letterMap[f]||'0')+m[1].slice(1); }
        }
        if(/Vitality Membership Status:/i.test(line)) {
          const m=line.match(/Vitality Membership Status:\s*([A-Za-z]+)/i); if(m) vitalityStatus=m[1].trim();
        }
        if(/Vitality Membership Fee Due Date:/i.test(line)) {
          const m=line.match(/Vitality Membership Fee Due Date:\s*([A-Za-z]{3}\s*\d{1,2},\s*\d{4})/i); if(m) tmpVitalDue=m[1].trim();
        }
      });

      if(policy) document.getElementById('policyNumber').value=policy;
      if(owner) document.getElementById('ownerName').value=owner;
      if(insured) document.getElementById('insuredName').value=insured;
      if(hkPremiumValue) document.getElementById('premiumRaw').value = hkPremiumValue;
      if(dueIso) document.getElementById('dueDate').value=dueIso;
      window.paymentMode = paymentModeDisplay; // å¹´ç¹³/æœˆç¹³é¡¯ç¤ºç”¨

      // æ¸…ç©º webhook è¦†å¯«
      _overrideOwnerShort = _overrideInsuredShort = null;
      _overrideVitality = null;

      generateMessages();
    }

    function vitalityBlock(){
      // ä»¥ webhook è¦†å¯«å„ªå…ˆ
      const v = _overrideVitality || (vitalityAccount && vitalityStatus && tmpVitalDue && vitalityStatus.toLowerCase()!=='terminated'
        ? {account:vitalityAccount, status:vitalityStatus, due:tmpVitalDue, payType:'05', amountHKD:430} : null);

      if (!v) return '';
      const d=new Date(v.due || v.dueISO);
      const vDue=`${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
      return `

â—ï¸Vitality ä¿¡æ¯ï¼šâ€¼ï¸
å¸³æˆ¶è™Ÿç¢¼ï¼š${v.account}
å¸³æˆ¶ç‹€æ…‹ï¼š${v.status}
ç¹³è²»é¡å‹ï¼š${v.payType || '05'}
åˆ°æœŸæ—¥ï¼š${vDue}
ç¹³è²»é‡‘é¡ï¼šæ¸¯å¹£${v.amountHKD ?? 430}
`;
    }

    function buildPayload() {
      const policy = (document.getElementById('policyNumber').value||'').trim();
      const owner  = (document.getElementById('ownerName').value||'').trim();
      const insured= (document.getElementById('insuredName').value||'').trim();
      const dueISO = (document.getElementById('dueDate').value||'').trim();
      const premHK = (document.getElementById('premiumRaw').value||'0').toString();
      const pm     = window.paymentMode || '';

      const fChar  = policy.charAt(0).toUpperCase();
      const payNo  = (letterMap[fChar]||'0') + policy.slice(1);

      const ownerShort   = _overrideOwnerShort ?? shortName(owner);
      const insuredShort = _overrideInsuredShort ?? shortName(insured);
      const dateCN       = formatDateCNLocal(dueISO);

      const whats =
`ğŸŒŸ **æº«é¦¨æç¤º** ğŸŒŸ

ä½ å¥½å‘€ï¼ğŸ˜ŠğŸŒˆ

ä½ çš„ä¿è²»å³å°‡åˆ°æœŸå–‡ï¼š
- *æŒæœ‰äºº*ï¼š${ownerShort}
- *ç¹³è²»è™Ÿç¢¼*ï¼š${payNo}
- *ç¹³è²»é¡å‹*ï¼š${MAIN_PAY_TYPE}
- *å—ä¿äºº*ï¼š${insuredShort}
- *ä¿è²»åˆ°æœŸæ—¥*ï¼š${dateCN}
- *ä¿è²»*ï¼šæ¸¯å…ƒ${premHK}
- *ç¹³ä»˜å½¢å¼*ï¼š${pm}
` + vitalityBlock() + `

è¨˜å¾—åœ¨åˆ°æœŸæ—¥å‰ç¹³è²»å•¦ï¼å¦‚æœæœ‰ä»»ä½•å•é¡Œï¼Œéš¨æ™‚å¯ä»¥è¯çµ¡æˆ‘å€‘ã€‚ğŸ“ğŸ’¬

æ„Ÿè¬ä½ çš„æ”¯æŒï¼ğŸŒŸğŸŒº`;

      const wechat =
`ğŸŒŸ æº«é¦¨æç¤º ğŸŒŸ

ä½ å¥½å‘€ï¼ğŸ˜ŠğŸŒˆ

ä½ çš„ä¿è²»å³å°‡åˆ°æœŸå–‡ï¼š
- æŒæœ‰äººï¼š${ownerShort}
- ç¹³è²»é¡å‹ï¼š${MAIN_PAY_TYPE}
- ç¹³è²»è™Ÿç¢¼ï¼š${payNo}
- å—ä¿äººï¼š${insuredShort}
- ä¿è²»åˆ°æœŸæ—¥ï¼š${dateCN}
- ä¿è²»ï¼šæ¸¯å…ƒ${premHK}
- ç¹³ä»˜å½¢å¼ï¼š${pm}
` + vitalityBlock() + `

è¨˜å¾—åœ¨åˆ°æœŸæ—¥å‰ç¹³è²»å•¦ï¼å¦‚æœæœ‰ä»»ä½•å•é¡Œï¼Œéš¨æ™‚å¯ä»¥è¯çµ¡æˆ‘å€‘ã€‚ğŸ“ğŸ’¬`;

      // Vitality çµæ§‹ï¼ˆè‹¥éœ€è¦ webhook ä½¿ç”¨ï¼‰
      let vitality = null;
      if (_overrideVitality){
        const d = new Date(_overrideVitality.due || _overrideVitality.dueISO);
        vitality = {
          account: _overrideVitality.account,
          status:  _overrideVitality.status,
          payType: _overrideVitality.payType || '05',
          dueISO:  d.toISOString().slice(0,10),
          amountHKD: _overrideVitality.amountHKD ?? 430
        };
      } else if (vitalityAccount && vitalityStatus && tmpVitalDue && vitalityStatus.toLowerCase()!=='terminated'){
        const d = new Date(tmpVitalDue);
        vitality = {
          account: vitalityAccount,
          status:  vitalityStatus,
          payType: '05',
          dueISO:  d.toISOString().slice(0,10),
          amountHKD: 430
        };
      }

      return {
        source: 'premium-reminder',
        version: '2025-11-02',
        policyNumber: policy,
        payNumber: payNo,
        payType: MAIN_PAY_TYPE,
        ownerName: owner,
        insuredName: insured,
        premiumHKD: premHK,
        premiumCurrency: 'HKD',
        dueDateISO: dueISO,
        dueDateText: dateCN,
        payModeDisplay: pm,
        vitality,
        rawInput: document.getElementById('rawInput').value,
        messages: { whatsapp: whats, wechat },
        createdAt: new Date().toISOString()
      };
    }

    function generateMessages(){
      const p = buildPayload();
      lastPayload = p;
      document.getElementById('whatsappMsg').value = p.messages.whatsapp;
      document.getElementById('wechatMsg').value  = p.messages.wechat;

      if (document.getElementById('autoWebhook').checked) {
        sendToWebhook();
      }
    }

    // æ¥æ”¶ webhook response ä¸¦è¦†å¯«ç•«é¢
    function applyWebhookResult(data){
      if(!data) return;

      if (data.messages) {
        if (data.messages.whatsapp) document.getElementById('whatsappMsg').value = data.messages.whatsapp;
        if (data.messages.wechat)   document.getElementById('wechatMsg').value   = data.messages.wechat;
      }
      if (data.overrides) {
        const o = data.overrides;
        if (o.premiumHKD)        document.getElementById('premiumRaw').value = o.premiumHKD;
        if (o.payModeDisplay)    window.paymentMode = o.payModeDisplay;
        if (o.dueDateISO)        document.getElementById('dueDate').value = o.dueDateISO;
        if (o.ownerShort)        _overrideOwnerShort   = o.ownerShort;
        if (o.insuredShort)      _overrideInsuredShort = o.insuredShort;
      }
      if (data.vitality) {
        _overrideVitality = {
          account:   data.vitality.account,
          status:    data.vitality.status,
          payType:   data.vitality.payType || '05',
          due:       data.vitality.dueISO || data.vitality.due,
          amountHKD: data.vitality.amountHKD ?? 430
        };
      }
    }

    async function sendToWebhook(){
      try{
        const payload = lastPayload || buildPayload();
        if(!WEBHOOK_URL){ setStatus('æœªè¨­å®š Webhook URL', true); return; }

        setStatus('å‚³é€ä¸­â€¦');
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const txt = await res.text();
          throw new Error(`HTTP ${res.status} ${txt || ''}`);
        }

        let data;
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) data = await res.json();
        else {
          const txt = await res.text();
          try { data = JSON.parse(txt); } catch { data = null; }
        }

        if (data) {
          applyWebhookResult(data);
          // é‡æ–°ä»¥ webhook çš„è¦†å¯«è³‡æ–™å†çµ„ä¸€æ¬¡è¨Šæ¯ï¼ˆå¯é¸ï¼‰
          const p2 = buildPayload();
          document.getElementById('whatsappMsg').value = p2.messages.whatsapp;
          document.getElementById('wechatMsg').value  = p2.messages.wechat;
          lastPayload = p2;
        }

        setStatus('å·²é€å‡º âœ…', false);
      }catch(err){
        console.error(err);
        setStatus('é€å‡ºå¤±æ•—ï¼š' + err.message, true);
      }
    }

    function setStatus(msg, isErr=false){
      const el = document.getElementById('hookStatus');
      el.textContent = msg||'';
      el.className = 'status ' + (isErr? 'err':'ok');
      if(msg){ setTimeout(()=>{ el.textContent=''; el.className='status'; }, 6000); }
    }

    function copyToClipboard(id){
      const el = document.getElementById(id);
      el.select(); el.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(el.value).then(()=>alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼'));
    }
  </script>
</body>
</html>
